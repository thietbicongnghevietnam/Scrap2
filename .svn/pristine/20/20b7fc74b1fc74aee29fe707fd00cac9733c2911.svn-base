using Azure.Core;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Newtonsoft.Json;
using ScrapSystem.Api.Application.DTOs.LabelListDtos;
using ScrapSystem.Api.Application.DTOs.ScrapDetailDtos;
using ScrapSystem.Api.Application.DTOs.ScrapDtos;
using ScrapSystem.Api.Application.DTOs.ScrapImageDtos;
using ScrapSystem.Api.Application.DTOs.VerifyDataDtos;
using ScrapSystem.Api.Application.Request;
using ScrapSystem.Api.Application.Response;
using ScrapSystem.Api.Utilities;
using ScrapSystem.Web.Dtos;
using ScrapSystem.Web.Models;
using ScrapSystem.Web.Service.Interface;
using Serilog;
using System.Collections.Generic;
using System.Diagnostics;
using System.Text.Json;
using X.PagedList;

namespace ScrapSystem.Web.Controllers
{
    [AuthorizeApi]
    public class ScrapController : BaseController
    {
        private readonly IApiClientService _apiClientService;
        public ScrapController(IApiClientService apiClientService)
        {
            _apiClientService = apiClientService;
        }

        [HttpGet]
        public IActionResult Import()
        {
            return View();
        }

        [HttpGet]
        public IActionResult Verify()
        {
            return View();
        }

        [HttpGet]
        public async Task<IActionResult> Index(DateTime startDate, DateTime endDate, string sanction = "")
        {
            try
            {
                Dictionary<string, string> data = new Dictionary<string, string>();
                data.Add("startDate", startDate.ToString("yyyy-MM-dd"));
                data.Add("endDate", endDate.ToString("yyyy-MM-dd"));
                if (!string.IsNullOrEmpty(sanction))
                    data.Add("sanction", sanction);
                var res = await _apiClientService.GetAsync<ApiResult<MasterDetailDto<LabelListMasterDto, LabelListDetailDto>>>("api/Scrap/label-list", data);
                if (!res.IsSuccess)
                    return View();
                ViewBag.StartDate = startDate.ToString("yyyy-MM-dd");
                ViewBag.EndDate = endDate.ToString("yyyy-MM-dd");
                ViewBag.Sanction = sanction;
                return View(res.MasterDetail);
            }
            catch (Exception)
            {
                return View();
                throw;
            }
        }

        [HttpPost]
        public async Task<IActionResult> Verify(VerifyRequest request)
        {
            Dictionary<string, IFormFile> files = new Dictionary<string, IFormFile>();
            Dictionary<string, string> param = new Dictionary<string, string>();
            files.Add("File", request.File);
            param.Add("Type", request.Type);
            var res = await _apiClientService.PostFileAsync("api/Verify/data", files, param);
            var rs = JsonConvert.DeserializeObject<List<List<VerificationResult>>>(res.MasterDetail.ToString());
            return View(rs);
        }

        [HttpGet]
        public async Task<IActionResult> Report([FromQuery] ScrapRequest request)
        {
            request.StartDate = request.StartDate == default ? DateTime.Now.AddMonths(-5) : request.StartDate;
            request.EndDate = request.EndDate == default ? DateTime.Now : request.EndDate;
            request.Page = request.Page <= 0 ? 1 : request.Page;
            request.PageSize = request.PageSize <= 0 ? 25 : request.PageSize;
            request.Sanction = request.Sanction == null? "" : request.Sanction;
            var rs = await _apiClientService.PostAsync<ApiResult<ScrapViewDto>>("api/Scrap/load-data", request);

            if (rs == null || rs.PagedResult?.Records == null)
            {
                return View(new StaticPagedList<ScrapViewDto>(new List<ScrapViewDto>(), request.Page, request.PageSize, 0));
            }

            ViewBag.StartDate = request.StartDate.ToString("yyyy-MM-dd");
            ViewBag.EndDate = request.EndDate.ToString("yyyy-MM-dd");
            ViewBag.Status = request.Status;
            ViewBag.Sanction = request.Sanction;
            ViewBag.PageSize = request.PageSize;

            var result = new ReportViewModel<ScrapViewDto>
            {
                SelectedStatus = request.Status,
                PageLists = new StaticPagedList<ScrapViewDto>(rs.PagedResult.Records, request.Page, request.PageSize, rs.PagedResult.TotalCount)

            };

            return View(result);
        }

        [HttpPost]
        public async Task<IActionResult> Import(ImportRequest request)
        {
            Dictionary<string, IFormFile> files = new Dictionary<string, IFormFile>();
            Dictionary<string, string> param = new Dictionary<string, string>();
            files.Add("file", request.File);
            param.Add("sanction", request.Sanction);
            param.Add("section", request.Section);
            var res = await _apiClientService.PostFileAsync("api/Scrap/import", files, param);
            var rs = JsonConvert.DeserializeObject<ParentWithChildren<ScrapDto, ScrapDetailDto>>(res.MasterDetail.ToString());
            return Ok(rs);
        }

        [HttpPost]
        public async Task<IActionResult> ImportFileName(ImportRequest request)
        {
            var rs = await _apiClientService.PostAsync<ApiResult<ScrapViewDto>>("api/Scrap/import-material-name", request);
            return Ok(rs.Items);
        }

        [HttpGet]
        public async Task<IActionResult> LoadImage(string sanctionId, string pallet)
        {
            Dictionary<string, string> data = new Dictionary<string, string>();
            data.Add("sanctionId", sanctionId);
            data.Add("pallet", pallet);
            var rs = await _apiClientService.GetAsync<ApiResult<MasterDetailDto<ScrapImageDto, ScrapImageDetailDto>>>("api/Scrap/load-image", data);
            return Ok(rs.MasterDetail);
        }

        [HttpGet]
        public async Task<IActionResult> GenerateAppendix(DateTime startDate, DateTime endDate, string appendix)
        {
            Dictionary<string, string> param = new Dictionary<string, string>();
            param.Add("startDate", startDate.ToString("yyyy-MM-dd"));
            param.Add("endDate", endDate.ToString("yyyy-MM-dd"));
            param.Add("appendix", appendix);
            var rs = await _apiClientService.GetAsync<ApiResult<byte[]>>("api/Scrap/generate-appendix", param);

            var fileBytes = rs.Item;
            var fileName = $"Appendix_{DateTime.Now:yyyyMMddHHmmss}.xlsx";

            return File(fileBytes,
                        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                        fileName);
        }

        [HttpPost]
        public async Task<IActionResult> ExportToPdf(List<string> beforeImages, List<string> afterImages, string barcode, DateTime date)
        {

            var rs = PdfHelper.ExportImagesToPdf(beforeImages, afterImages, barcode, date);
            return File(rs,
                        "application/pdf",
                        $"ExportedPdf_{DateTime.Now:yyyyMMddHHmmss}.pdf");
        }

        [HttpDelete("DeleteScrapDetail/{id}")]
        public async Task<IActionResult> DeleteScrapDetail(int id)
        {
            try
            {
                await _apiClientService.DeleteAsync($"api/Scrap/scrap-detail/{id}");

            }
            catch (Exception ex)
            {
                return BadRequest(ex.Message);
                throw;
            }
            return Ok();
        }

        [HttpPut("UpdateScrapDetail/{id}")]
        public async Task<IActionResult> UpdateScrapDetail(int id, int qty)
        {
            try
            {
                var data = new UpdateQtyRequest { Qty = qty };

                var res = await _apiClientService.PutAsync<ApiResult<bool>>($"api/Scrap/scrap-detail/{id}", data);
                if (!res.IsSuccess)
                    return BadRequest();
                return Ok();
            }
            catch (Exception ex)
            {
                return BadRequest(ex.Message);
            }
        }

    }

}
